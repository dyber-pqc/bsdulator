# BSDulator CI/CD Pipeline
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  FREEBSD_VERSION: "15.0-RELEASE"

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        compiler: [gcc, clang]
        build_type: [release, debug]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ${{ matrix.compiler }} \
            iproute2 \
            iptables \
            bridge-utils \
            wget \
            curl

      - name: Build BSDulator (${{ matrix.compiler }} - ${{ matrix.build_type }})
        run: |
          if [ "${{ matrix.compiler }}" = "clang" ]; then
            export CC=clang
          else
            export CC=gcc
          fi
          
          if [ "${{ matrix.build_type }}" = "debug" ]; then
            make debug
          else
            make
          fi

      - name: Verify build artifacts
        run: |
          test -x ./bsdulator
          test -x ./lochs
          ./bsdulator --version
          ./lochs --help

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: matrix.compiler == 'gcc' && matrix.build_type == 'release'
        with:
          name: bsdulator-linux-amd64
          path: |
            bsdulator
            lochs

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            iproute2 \
            iptables \
            bridge-utils \
            wget

      - name: Build BSDulator
        run: make

      - name: Run compatibility checker
        run: ./scripts/check_compat.sh

      - name: Download FreeBSD base system
        run: |
          ./scripts/setup_freebsd_root.sh
        timeout-minutes: 10

      - name: Run test suite
        run: ./tests/run_tests.sh

      - name: Test FreeBSD static binaries
        run: |
          ./bsdulator ./freebsd-root/rescue/echo "Hello from CI"
          ./bsdulator ./freebsd-root/rescue/pwd
          ./bsdulator ./freebsd-root/rescue/ls -la ./freebsd-root/rescue/ | head -10

      - name: Test FreeBSD dynamic binaries
        run: |
          ./bsdulator ./freebsd-root/libexec/ld-elf.so.1 ./freebsd-root/bin/echo "Dynamic binary test"
          ./bsdulator ./freebsd-root/libexec/ld-elf.so.1 ./freebsd-root/bin/ls -la / | head -10

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install linting tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck clang-format

      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,performance \
                   --error-exitcode=1 \
                   --suppress=missingIncludeSystem \
                   --suppress=unusedStructMember \
                   --suppress=constParameterPointer \
                   --suppress=constParameterCallback \
                   --suppress=unreadVariable \
                   --inline-suppr \
                   -I include \
                   src/

      - name: Check code formatting
        run: |
          find src include -name '*.c' -o -name '*.h' | head -5 | xargs clang-format --dry-run --Werror || true
        continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: c-cpp

      - name: Build for analysis
        run: make

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            iproute2 \
            iptables \
            bridge-utils \
            wget \
            socat

      - name: Build BSDulator
        run: make

      - name: Setup FreeBSD root
        run: ./scripts/setup_freebsd_root.sh

      - name: Test Lochs CLI
        run: |
          ./lochs --help
          ./lochs version
          ./lochs images ls || true

      - name: Test jail creation (requires sudo)
        run: |
          sudo ./bsdulator ./freebsd-root/libexec/ld-elf.so.1 \
            ./freebsd-root/usr/sbin/jail -c name=ci_test path=./freebsd-root persist || true
          sudo ./bsdulator ./freebsd-root/libexec/ld-elf.so.1 \
            ./freebsd-root/usr/sbin/jls || true
          sudo ./bsdulator ./freebsd-root/libexec/ld-elf.so.1 \
            ./freebsd-root/usr/sbin/jail -r 1 || true
